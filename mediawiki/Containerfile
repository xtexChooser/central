FROM docker.io/library/php:8.1-fpm-alpine

LABEL org.opencontainers.image.title=MediaWiki
LABEL org.opencontainers.image.vendor="XV-NET"
LABEL org.opencontainers.image.source="https://codeberg.org/xvnet/containers"

RUN apk add --no-cache git diffutils imagemagick python3

RUN apk add --no-cache --virtual .build-deps $PHPIZE_DEPS icu-dev oniguruma-dev libpq-dev; \
    docker-php-ext-install -j 8 \
        calendar \
        intl \
        mbstring \
#        mysqli \
        opcache \
        pgsql \
        pdo_pgsql; \
    pecl install APCu-5.1.21; \
    docker-php-ext-enable apcu; \
    rm -r /tmp/pear; \
    runDeps="$( \
        scanelf --needed --nobanner --format '%n#p' --recursive /usr/local/lib/php/extensions \
            | tr ',' '\n' \
            | sort -u \
            | awk 'system("[ -e /usr/local/lib/" $1 " ]") == 0 { next } { print "so:" $1 }' \
    )"; \
    echo $runDeps; \
    apk add --virtual .mediawiki-phpext-rundeps $runDeps; \
    apk del .build-deps

# https://secure.php.net/manual/en/opcache.installation.php
RUN { \
        echo 'opcache.memory_consumption=128'; \
        echo 'opcache.interned_strings_buffer=8'; \
        echo 'opcache.max_accelerated_files=4000'; \
        echo 'opcache.revalidate_freq=60'; \
        echo 'opcache.fast_shutdown=1'; \
    } > /usr/local/etc/php/conf.d/opcache-recommended.ini

RUN cp "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"

ENTRYPOINT ["php-fpm"]
