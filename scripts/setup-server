#!/usr/bin/env bash
set -xe

# Update system
initPkgs="pacman -Sy archlinux-keyring --noconfirm; pacman -Syuu --noconfirm; pacman -S bash fish make coreutils sudo --noconfirm"
if command -v sudo >/dev/null; then
	sudo bash -c "$initPkgs"
else
	su -c "$initPkgs"
fi

# Configure system basics
sudo usermod -a -G root "$(whoami)"

# Fetch atremis
if ! [[ -e "/srv/atremis" ]]; then
	sudo mkdir -p /srv
	pushd /srv
	sudo git clone --depth 1 --recurse-submodules --shallow-submodules --single-branch https://codeberg.org/xens/atremis.git
	sudo chmod -R a+r atremis
	popd
else
	pushd /srv/atremis
	sudo git fetch origin main
	sudo git reset --hard FETCH_HEAD
	popd
fi

if ! [[ -e "/srv/secrets" ]]; then
	sudo mkdir /srv/secrets
	sudo chmod -R 0772 /srv/secrets
fi

# Update
pushd /srv/atremis
./atre pull || true
for ((i = 0; i < 2; i++)); do
	./atre apply || true
done
./atre apply
./atre update
popd

# Validation
command -v atre

echo "===== SUCCEED ====="
echo "PRESS ANY KEY TO RESTART OR CTRL+C TO ABORT"
read -n1 -r && sudo systemctl reboot
