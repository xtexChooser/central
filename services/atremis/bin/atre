#!/usr/bin/env bash

atreDir=/srv/atremis
svc="sudo -u service"
if [[ "$(id -un)" == "service" ]]; then
	svc=""
	isSvcUser="true"
fi

set -e

function atre::log {
	echo -e "\e[0;34m${FUNCNAME[1]}: $*\e[0m"
}

function atre::error {
	echo -e "\e[0;31matre: $*\e[0m" 1>&2
	exit 1
}

function atre::succ {
	echo -e "\e[0;32m$*\e[0m"
}

function atre::usage {
	cat 1>&2 <<XXX
usage: $0 <COMMAND>

COMMAND:
    help                        Print usage
    pull                        Pull changes from repository
    apply                       Apply configuration
XXX
}

function atre::pull {
	cd $atreDir

	atre::log "Pull updates"
	{
		set +e
		$svc git fetch --force --depth 1 origin
		$svc git reset --hard origin/main
		$svc git submodule update --init --recursive
		$svc git -c gc.reflogExpire=1 -c gc.reflogExpireUnreachable=0 \
			-c gc.rerereResolved=0 -c gc.rerereUnresolved=0 \
			-c gc.pruneExpire=now gc
	}

	atre::log "Current commits"
	git show --oneline --no-patch --no-abbrev-commit HEAD
	git submodule -q foreach git show --oneline --no-patch --no-abbrev-commit HEAD

	atre::apply
}

function atre::apply {
	cd $atreDir
	if [[ "$isSvcUser" == "true" ]]; then
		atre::log "Apply configuration"
		DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus
		export DBUS_SESSION_BUS_ADDRESS
		make apply
	else
		atre::log "Restart Atremis as service user"
		$svc atre apply
	fi
}

function atre::main {
	[ $# -eq 0 ] && atre::usage && exit
	[ ! -d "$atreDir" ] && atre::error "$atreDir does not exist"

	case $1 in
	help | --help)
		atre::usage "$@"
		exit
		;;
	pull)
		atre::pull "$@"
		;;
	apply)
		atre::apply "$@"
		;;
	*)
		atre::error "unknown option: $1"
		;;
	esac
}

atre::main "$@"
