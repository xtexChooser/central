FROM docker.io/library/alpine:edge AS builder

ADD src /bld
WORKDIR /bld

# Build dependencies:
# openssl-dev perl make: for vendored openssl
# curl: for utoipa-swagger-ui
# cmake: for ruma-common
# rust-bindgen, clang: for aws-lc-sys
# FIXME: remove :edge and apk update when rust 1.81 in available in alpine main repo
RUN set -euxo pipefail; \
	apk update; \
	apk add --no-cache build-base rust cargo musl-dev just nodejs npm bash \
		openssl-dev perl make curl sd cmake rust-bindgen clang18-libclang; \
	export PUB_URL="127.0.0.1:8443"; \
	export DATABASE_URL="postgresql://rauthy:builder@prepare-database/rauthy"; \
	cd frontend; \
	npm install; \
	cd ..; \
	just build-ui; \
	cargo build \
		--release;

FROM docker.io/library/alpine

RUN apk add --no-cache libgcc

ARG TARGET_USER="10001:10001"
USER $TARGET_USER

COPY --from=builder --chown=$TARGET_USER /bld/target/release/rauthy /usr/bin/rauthy

WORKDIR /etc/populus
ENTRYPOINT ["/usr/bin/rauthy"]

LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL org.opencontainers.image.source="https://codeberg.org/xens/atremis"
LABEL org.opencontainers.image.title="Populus"
LABEL org.opencontainers.image.url="https://codeberg.org/xens/populus"
LABEL org.opencontainers.image.vendor="Xensor V Project"
