#!/usr/bin/env sh
set -eux

apk add --no-cache \
	build-base rust cargo musl-dev postgresql-client
cargo install sqlx-cli --no-default-features --features rustls,postgres
export PATH="$HOME/.cargo/bin:$PATH"
cd populus-src

# prepare the database
export PGPASSWORD=builder
psql -h prepare-database -U postgres -d postgres -a <<EOF
create user rauthy with password 'builder';
create database rauthy with owner rauthy;
EOF
psql -h prepare-database -U postgres -d rauthy -a <<EOF
create schema rauthy authorization rauthy;
EOF

# prepare for sqlx offline build
export DATABASE_URL="postgresql://rauthy:builder@prepare-database/rauthy"
sqlx migrate run --source migrations/postgres

cd ..
# prepare for container to use
mv -v populus-src services/populus/build/src
